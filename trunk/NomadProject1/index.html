<!DOCTYPE html>
<html>
<head>
    <title>Antenna Aligner</title>
    <script type="text/javascript" charset="utf-8" src="scripts/cordova.js"></script>
    <script src="scripts/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="scripts/jquery.mobile-1.2.0.js" type="text/javascript"></script>
    <script src="scripts/xui.js" type="text/javascript"></script>
    <script src="scripts/positionUtils.js" type="text/javascript"></script>
    <script src="scripts/txdata.js" type="text/javascript"></script>
    <script src="scripts/signal.js" type="text/javascript"></script>
    <link rel="Stylesheet" href="style/jquery.mobile-1.2.0.css" />   
    <link rel="Stylesheet" href="style/jquery-overrides.css" />   
    <link rel="Stylesheet" href="style/master.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" charset="utf-8">

        var $j = jQuery;

        // This should hopefully lock the orientation...
        window.shouldRotateToOrientation = function (newOrientation) {
            return false;
        };

        var lastPosition;
        var nearest5Tx;
        var m_SelectedTxIndex = -1;
        var m_SelectedTxBearing;
        var c_DistanceLimit = 100; // in km

        function onDeviceReady() {
            injectTxlist();
        }


        // ******************************************************************************]
        // Location Methods
        function getLocationData() {
            if (navigator.geolocation)
            {
                var geolocationOptions = { enableHighAccuracy: true };

                navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, geolocationOptions);
            }
            else {
                onLocationError("no geolocation");
            }
        }

        function onLocationSuccess(position) {
            $.mobile.hidePageLoadingMsg();

            lastPosition = position;

            calculateNearestTx(lastPosition);
        }

        // onError Callback receives a PositionError object
        //
        function onLocationError() {

            $.mobile.hidePageLoadingMsg();

            // Show that the GPS is disabled in the transmitter list.
            $('.txlist').empty();
            $('.txlist').append($('<li/>', {
                'data-role': "list-divider",
                'html': "GPS Disabled"
            }));

            showRecalculateButton();

            $('.txlist').listview('refresh');

            $.mobile.changePage('gpserrordialog.html', {
                transition: 'none',
                reverse: false,
                changeHash: true
            });
        }

        function selectTx(index) {

            if (index >= nearest5Tx.length) // if we've clicked on a button that has no entry in the nearest array, do nothing.
                return;

            m_SelectedTxIndex = index;
        }


        function calculateNearestTx(position) {
            $('.txlist').empty();

            nearest5Tx = getNearestTx(position);

            $('.txlist').empty();

            for (var i = 0; i < 5; i++) {
                if (i < nearest5Tx.length) {
                    
                    var distance = parseFloat(nearest5Tx[i].distanceMiles);
                    distance = distance.toFixed(1);

                    var signalStrength = nearest5Tx[i].signalStrength;

                    var iconClass = "ui-icon-good";
                    if (signalStrength < 66) {
                        iconClass = 'ui-icon-poor';
                    } else if (signalStrength < 72) {
                        iconClass = 'ui-icon-low';
                    }

                    var polarisation = nearest5Tx[i].pol;

                    var polClass = "ui-pol-horiz";
                    if (polarisation == 'V')
                        polClass = "ui-pol-vert";

                    var tempfloat = parseFloat(getBearing(lastPosition, nearest5Tx[i].position)); // parse as float
                    if (tempfloat < 0)
                        tempfloat = 360 + tempfloat;

                    nearest5Tx[i].bearing = tempfloat.toFixed(2);  // Will return "10.00"

                    var displayBearing = tempfloat.toFixed(0);

                    var buttonHtml = '<table width="100%"><tr>';
                    buttonHtml += '<td class="txListName" colspan="2">' + nearest5Tx[i].name + '</td>';
                    buttonHtml += '<td class="bearingCell">' + displayBearing + '&deg;</td>';
                    buttonHtml += '</tr><tr>';
                    buttonHtml += '<td class="distanceCell" width="30%">' + distance + ' miles</td>';
                    buttonHtml += '<td class="distanceCell"><div class="' + polClass + '"></div></td>';
                    buttonHtml += '<td width="60px" align="center"><div class="' + iconClass + '"></div></td>';
                    buttonHtml += '</tr></table>';

                    $('.txlist').append($('<li/>', {    //here appendin `<li>`
                        'data-role': "list-divider",
                        'class' : 'txlistitem'
                    }).append($('<a/>', {    //here appending `<a>` into `<li>`
                        'href': '#',
                        'data-transition': 'none',
                        'onclick': 'selectTx(' + i + ');injectCompass(); closeMenu()',
                        'html': buttonHtml
                    })));
                    
                }
            }
            $('.txlist').listview('refresh');

            showRecalculateButton();

            $("#txoptions").show();
        }

        function showRecalculateButton() {

            var recalcHtml = '<table width="100%"><tr>';
            recalcHtml += '<td class="txListName" align="center" >Recalculate</td>';
            recalcHtml += '</tr></table>';

            $('.txlist').append($('<li/>', {    //here appendin `<li>`
                'data-role': 'list-divider'
            }).append($('<a/>', {    //here appending `<a>` into `<li>`
                'data-transition': 'none',
                'html': recalcHtml,
                'onclick': 'getLocationData()'
            })));
            $('.txlist').listview('refresh');

        }

        // End location methods
        // *******************************************************************************

        var windowWidth = $(window).width();
        var menuWidth = 200;

        $(function () {

            $('#menu').css({ 'left': windowWidth - menuWidth + 'px' });

            $('#menubutton').toggle(
                function () { openMenu(); },
                function () { closeMenu(); }
            );
        });

        function openMenu() {
            $('#page1').animate({ left: -1 * menuWidth }, 100, function () {
                $('#menubutton').html('Close');
            });
        }

        function closeMenu() {
            $('#page1').animate({ left: 0 }, 100, function () {
                $('#menubutton').html('Menu');
            });
        }
        
        // click the menu button to close using the toggle.
        function closeClickMenu() {
            $('#menubutton').click();
        }
        
        function injectAbout() {
            $.get('aboutinjecttest.html', function (data) {
                $('#mainpage').html(data);
                $("div[data-role=page]").page("destroy").page();
            });
        }
        
        function injectTxlist() {
            $.get('txlist.html', function (data) {
                $('#mainpage').html(data).trigger('create');
                
                getLocationData();
                
                $("div[data-role=page]").page("destroy").page();
            });

            

        }
        
        function injectCompass() {

            $.get('compass.html', function (data) {
                $('#mainpage').html(data);
                populateCompassTxDataPanel();
                
                $("div[data-role=page]").page("destroy").page();
            });
        }

 

        document.addEventListener("deviceready", onDeviceReady, false);
    </script>
</head>
<body>
    <div data-role="page" id="page1" >         
        <div data-role="header">
            <div id="backbutton" class="backbutton" onclick="injectTxlist()" data-icon="delete">Back</div>

            <h1>Antenna Aligner</h1>         
            
            <!-- <a href="about.html" data-icon="info" class="ui-btn-right" data-iconpos="notext" data-theme="a" data-shadow="false" data-icon-shadow="false">Button Right</a>             -->
            
            <div id="menubutton" data-icon="info" class="menubutton" data-iconpos="notext">
                Menu
            </div>
        </div>
        <div data-role="content" id="mainpage">
            
            <!-- page content to be injected here -->
              
        </div>
        
    </div>
    
    <div id="menu" class="slidingmenu">
        <ul>
            <li onclick="injectAbout(); closeClickMenu();"><div class="menuitem">Help</div></li>
            <li onclick="injectTxlist(); closeClickMenu();"><div class="menuitem">Your Transmitters</div></li>
        </ul>
    </div>
    
</body>
</html>
