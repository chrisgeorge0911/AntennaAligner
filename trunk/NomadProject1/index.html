<!DOCTYPE html>
<html>
<head>
    <title>Antenna Aligner</title>
    <script type="text/javascript" charset="utf-8" src="scripts/cordova.js"></script>
    <script src="scripts/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="scripts/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
    <script src="scripts/xui.js" type="text/javascript"></script>
    <script src="scripts/positionUtils.js" type="text/javascript"></script>
    <script src="scripts/txdata.js" type="text/javascript"></script>
    <script src="scripts/signal.js" type="text/javascript"></script>
    <link rel="Stylesheet" href="style/jquery.mobile-1.1.0.min.css" />   
    <link rel="Stylesheet" href="style/fonts/ariblk.css" />
    <link rel="Stylesheet" href="style/master.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" charset="utf-8">

        var lastHeading = -1; 
        var lastPosition;
        var nearest5Tx;
        var m_SelectedTxIndex = -1;
        var m_SelectedTxBearing;
        var c_DistanceLimit = 100; // in km

        /**
        * Delay for a number of milliseconds
        */
        function sleep(delayms) {
            var start = new Date().getTime();
            while (new Date().getTime() < start + delayms);
        }


        function getLocationData() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onError);
            }
            else {
                position = {
                    coords: {
                        latitude: 51.7,
                        longitude: -0.45,
                        altitude: 40.5,
                        accuracy: 65,
                        altitudeAccuracy: 30,
                        heading: 0,
                        speed: 0,
                        timestamp: 0
                    }
                };
                onLocationSuccess(position);
            }           
        }

        function onLocationSuccess(position)
        {
            lastPosition = position;

            calculateNearestTx();
        }

        function getCompassData() {

            if (navigator.compass) {
                var options = { filter: 0.5 };
                
                if (eval("typeof navigator.compass.watchHeading == 'function'")) {
                    watchID = navigator.compass.watchHeading(success, onFail, options);
                }
            }        
            else {
                success(30);
            }          
        }

        function getNearestTx() {

            var txList = getListOfTxBySignalStrength(lastPosition);

            var txListTop5 = new Array();

            var top5ListCount = 0;
            // get the top 5 transmitters that have signal strength 66db+
            for (var i = 0; i < txList.length; i++) 
            {
                var currentTx = txList[i];

                if (currentTx.distance < c_DistanceLimit) {
                    txListTop5[top5ListCount] = txList[i];
                    txListTop5[top5ListCount].distanceMiles = txListTop5[top5ListCount].distance * 0.62137119;
                    top5ListCount++;
                }

                if ( txListTop5.length == 5)
                    break;
            }

            return txListTop5;
        }
        

        function success(heading) {
                   
            if (lastHeading === heading.magneticHeading) return;
            lastHeading = heading.magneticHeading;
            
            var compass = x$("#compass .compass");
                       
            compass.css({
                "-webkit-transform": "rotate(-" + lastHeading + "deg)",
                "transform": "rotate(-" + lastHeading + "deg)",
                "-moz-transform": "rotate(-" + lastHeading + "deg)",
                "z-index": "0"
            });

            if (m_SelectedTxIndex > -1) {

                var relativeHeading = parseFloat(m_SelectedTxBearing) - parseFloat(lastHeading);
                var needle = x$("#compass .needle");

                needle.css({
                    "-webkit-transform": "rotate(" + relativeHeading + "deg)",
                    "transform": "rotate(" + relativeHeading + "deg)",
                    "-moz-transform": "rotate(" + relativeHeading + "deg)",
                    "position": "absolute",
                    "z-index": "1"
                });
            }
        }
        
        function onFail() {
            alert("heading fail");
        }

        // onError Callback receives a PositionError object
        //
        function onError(error) {

            switch (error.code) {
                case 2:
                    message = "Please enable locations services on your device";
                    break;
                default:
                    message = 'code: ' + error.code + '\n' + 'message: ' + error.message + '\n';
            }

            $.mobile.changePage('#location', 'pop', false, true);
            
        }

        function onDeviceReady() {
            getLocationData();
        }

        function populateTxDataPanel() {

            tempfloat = parseFloat(getBearing(lastPosition, nearest5Tx[m_SelectedTxIndex].position)); // parse as float number
            m_SelectedTxBearing = tempfloat.toFixed(2);  // Will return "10.00"

            // reset lastHeading so that the compass is redrawn.
            lastHeading = -1;
            getCompassData();

            var nameDiv = document.getElementById('txName');
            var distanceDiv = document.getElementById('txDistance');
            var channelDiv = document.getElementById('txChannels');

            nameDiv.innerHTML = nearest5Tx[m_SelectedTxIndex].name;
            distanceDiv.innerHTML = parseFloat(nearest5Tx[m_SelectedTxIndex].distanceMiles).toFixed(1) + " miles";

            channelDiv.innerHTML = "Channels: " + nearest5Tx[m_SelectedTxIndex].ch1 + ", " + nearest5Tx[m_SelectedTxIndex].ch2 + ", " + nearest5Tx[m_SelectedTxIndex].ch3;
        }

        function selectTx(index) {

            if (index >= nearest5Tx.length) // if we've clicked on a button that has no entry in the nearest array, do nothing.
                return;
            
            m_SelectedTxIndex = index;
        }


        function calculateNearestTx() {

            $('ul').empty();

            nearest5Tx = getNearestTx();

            var latitude = parseFloat(lastPosition.coords.latitude);
            var longitude = parseFloat(lastPosition.coords.longitude);

            $("#locationdata").html('Latitude: ' + latitude.toFixed(1) + ', Longitude: ' + longitude.toFixed(1) + '<br />');

            $('ul').empty();

            for (var i = 0; i < 5; i++) {

                if (i < nearest5Tx.length) {

                    var distance = parseFloat(nearest5Tx[i].distanceMiles);
                    distance = distance.toFixed(1);

                    var signalStrength = nearest5Tx[i].signalStrength;

                    var iconClass = "ui-icon-good";
                    if (signalStrength < 66) {
                        iconClass = 'ui-icon-poor';
                    } else if (signalStrength < 72) {
                        iconClass = 'ui-icon-low';
                    }

                    var buttonHtml = '<table width="100%"><tr>';
                    buttonHtml += '<td class="txListName" colspan="3">' + nearest5Tx[i].name + '</td>';
                    buttonHtml += '</tr><tr>';
                    buttonHtml += '<td class="distanceCell" width="30%">' + distance + " miles</td>";
                    buttonHtml += '<td class="distanceCell">' + signalStrength + "dBµV/m</td>";
                    buttonHtml += '<td width="60px" align="left"><div class="' + iconClass + '"></div></td>';
                    buttonHtml += '</tr></table>';

                    $('ul').append($('<li/>', {    //here appendin `<li>`
                            'data-role': "list-divider"
                        }).append($('<a/>', {    //here appending `<a>` into `<li>`
                            'href': '#compasspage',
                            'data-transition': 'none',
                            'onclick': 'selectTx(' + i + ')',
                            'html': buttonHtml
                        })));

                    $('ul').listview('refresh');
                }
            }

            $("#txoptions").show();
        }

        $(document).on("click", ".show-page-loading-msg", function () {
            var $this = $(this),
                theme = $this.jqmData("theme") || $.mobile.loadingMessageTheme;
            $.mobile.showPageLoadingMsg(theme, "recalculating", false);

            setTimeout(function () { $.mobile.hidePageLoadingMsg(); }, 2000);

            getLocationData();
        })
		.on("click", ".hide-page-loading-msg", function () {
		    $.mobile.hidePageLoadingMsg();
		});
        
        document.addEventListener("deviceready", onDeviceReady, false);
    </script>
</head>
<body>
    <div data-role="page" id="page1">         
        <div data-role="header">
            <h1>Antenna Aligner</h1>         
            
            <a href="#infomain" data-icon="info" class="ui-btn-right" data-iconpos="notext" data-theme="a" data-shadow="false" data-icon-shadow="false">Button Right</a>             
        </div>
        <div data-role="content">            
            <div id="txoptions" data-role="fieldcontain">
                <div style="font-weight:bold;padding-bottom:6px">Select a transmitter from the list...</div>                
                <ul data-role="listview" data-divider-theme="d" data-inset="true">                
                    <li>Please wait...</li>
                </ul>             
                <a data-role="button" class="show-page-loading-msg">Recalculate</a>
            </div>
            
        </div>
    </div>
            
    <div data-role="page" id="compasspage" data-add-back-btn="true">
    <script>
       $("#compasspage").live('pagebeforeshow', function () {
            populateTxDataPanel();
        });

        $("#compasspage").live('pageshow', function () {
           
        });
        </script>

        <div data-role="header">
            <h1>Antenna Aligner</h1>
        </div>
        <div data-role="content">             
            <div class="datapanel">
                <div class="datapanel-top">
                    <div id="selectedTx">
                        <div id="txName">
                            <b>
                                ?
                            </b>
                        </div>
                        <table width="100%">
                            <tr>
                                <td width="50%"><span class="data" id="txDistance"></span></td>
                                <td style="text-align:right"><span class="data" id="txChannels"></span> </td>
                            </tr>
                        </table>
                    </div>
                </div>
            
                <div class="datapanel-bottom" id="compassdatapanel">     
                    <div id="compassdata"></div>           
                    <div id="compass" class="view">
                        <div class="container">
                            <img class="needle" id="needle" src="images/direction-needle.png">
                            <img class="compass" id="compassback" src="images/direction-indicator.png">
                        </div>
                        <div style="padding-left:5px;padding-right:5px;font-size: 13px;">
                            Keep away from any metallic objects as they may affect the compass.
                            </div>
                    </div>
                </div>     
            </div>       
        </div>
    </div>    
    

    <div data-role="page" id="infomain" data-add-back-btn="true">
        <div data-role="header">
            <h1>Antenna Aligner</h1>
        </div>
        <div data-role="content">
           
            <img src="images/logo.png" />
           
            <div class="datapanel">
                <div class="datapanel-top" style="padding-left: 10px;padding-right: 10px;padding-bottom:10px;">
                    Use this app to align your aerial to one of the Freeview transmitters.<br /><br />
                    Please note that the top rated transmitter may not necessarily be the best one for your location due to terrain and other structures.
                </div>
                <div class="datapanel-bottom" style="padding-left: 4px;padding-right: 4px;padding-top:10px;padding-bottom:10px;"> 
                    Problems or Suggestions?<br />
                    email <a href="mailto:aligner@chrisgeorge.org.uk">aligner@chrisgeorge.org.uk</a>
                </div>
            </div>
           
            <div class="datapanel" style="margin-top:15px;">
                <div class="datapanel-top" style="text-align:right;padding-left: 8px;padding-right: 8px;">
                    Powered by <a href="http:\\www.vsnomad.com">Nomad</a>
                </div>
                <div class="datapanel-bottom" style="text-align:right;padding-left: 8px;padding-right: 8px;">
                    Antenna Aligner &copy; 2012 Chris George
                </div>
            </div>
        </div>
    </div>
    
    <div data-role="dialog" id="location">
        <div data-role="header">
            <h1>GPS Error</h1>
        </div>
        <div data-role="content">
            <p>The GPS system is not enabled.</p>
            <p>To use Antenna Aligner, please enable the GPS in your device's settings.</p>        
        </div>
    </div>
</body>
</html>
