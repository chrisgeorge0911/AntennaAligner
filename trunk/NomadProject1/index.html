<!DOCTYPE html>
<html>
<head>
    <title>Antenna Aligner</title>
    <script type="text/javascript" charset="utf-8" src="scripts/cordova.js"></script>
    <script src="scripts/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="scripts/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
    <script src="scripts/xui.js" type="text/javascript"></script>
    <script src="scripts/positionUtils.js" type="text/javascript"></script>
    <script src="scripts/txdata.js" type="text/javascript"></script>
    <script src="scripts/signal.js" type="text/javascript"></script>
    <link rel="Stylesheet" href="style/jquery.mobile-1.1.0.min.css" />   
    <link rel="Stylesheet" href="style/master.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" charset="utf-8">

        var lastHeading = -1; 
        var lastPosition;
        var nearest5Tx;
        var m_SelectedTxIndex = -1;
        var m_SelectedTxBearing;
        var c_DistanceLimit = 100; // in km

        /**
        * Delay for a number of milliseconds
        */
        function sleep(delayms) {
            var start = new Date().getTime();
            while (new Date().getTime() < start + delayms);
        }


        function getLocationData() {
            if (navigator.geolocation) {
                var geolocationOptions = { enableHighAccuracy: true };
            
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onError, geolocationOptions);
            }
            else {
                onError("no geolocation");
            }           
        }

        function onLocationSuccess(position) {

            $.mobile.hidePageLoadingMsg();
            //$("#locationdata").html('Latitude: ' + latitude.toFixed(1) + ', Longitude: ' + longitude.toFixed(1) + '<br />');

            lastPosition = position;

            calculateNearestTx(lastPosition);
        }

        // onError Callback receives a PositionError object
        //
        function onError(error) {

            $.mobile.hidePageLoadingMsg();

            // Show that the GPS is disabled in the transmitter list.
            $('ul').empty();
            $('ul').append($('<li/>', {
                'data-role': "list-divider",
                'html': "GPS Disabled"
            }));

            $('ul').listview('refresh');

            $.mobile.changePage('#locationError', {
                transition: 'none',
                reverse: false,
                changeHash: true
            });
        }


        function getCompassData() {

            if (navigator.compass) {

                var options = { filter: 0.5 };
                if ( device.platform == 'Android')
                    options = { frequency: 50 };
                
                if (eval("typeof navigator.compass.watchHeading == 'function'")) {
                    watchID = navigator.compass.watchHeading(success, onFail, options);
                }
            }
            else {
                alert("compass not working");
                success(30);
            }          
        }


        function success(heading) {
                   
            if (lastHeading === heading.magneticHeading) return;
            lastHeading = heading.magneticHeading;
            
            var compass = x$("#compass .compass");
                       
            compass.css({
                "-webkit-transform": "rotate(-" + lastHeading + "deg)",
                "transform": "rotate(-" + lastHeading + "deg)",
                "-moz-transform": "rotate(-" + lastHeading + "deg)",
                "z-index": "0"
            });

            if (m_SelectedTxIndex > -1) {

                var relativeHeading = parseFloat(m_SelectedTxBearing) - parseFloat(lastHeading);
                var needle = x$("#compass .needle");

                needle.css({
                    "-webkit-transform": "rotate(" + relativeHeading + "deg)",
                    "transform": "rotate(" + relativeHeading + "deg)",
                    "-moz-transform": "rotate(" + relativeHeading + "deg)",
                    "position": "absolute",
                    "z-index": "1"
                });
            }
        }
        
        function onFail() {
            alert("heading fail");
        }

      

        function onDeviceReady() {
            getLocationData();
        }

        function populateTxDataPanel() {

            m_SelectedTxBearing = nearest5Tx[m_SelectedTxIndex].bearing;

            // reset lastHeading so that the compass is redrawn.
            lastHeading = -1;
            getCompassData();

            var nameDiv = document.getElementById('txName');
            var distanceDiv = document.getElementById('txDistance');
            var channelDiv = document.getElementById('txChannels');

            nameDiv.innerHTML = nearest5Tx[m_SelectedTxIndex].name;
            distanceDiv.innerHTML = parseFloat(nearest5Tx[m_SelectedTxIndex].distanceMiles).toFixed(1) + " miles";

            channelDiv.innerHTML = "Channels: " + nearest5Tx[m_SelectedTxIndex].ch1 + ", " + nearest5Tx[m_SelectedTxIndex].ch2 + ", " + nearest5Tx[m_SelectedTxIndex].ch3;
        }

        function selectTx(index) {

            if (index >= nearest5Tx.length) // if we've clicked on a button that has no entry in the nearest array, do nothing.
                return;
            
            m_SelectedTxIndex = index;
        }


        function calculateNearestTx(position) {

            $('ul').empty();

            //var latitude = parseFloat(position.coords.latitude);
            //var longitude = parseFloat(position.coords.longitude);

            //$("#locationdata").html('Latitude: ' + latitude.toFixed(1) + ', Longitude: ' + longitude.toFixed(1) + '<br />');

            nearest5Tx = getNearestTx(position);

            $('ul').empty();

            for (var i = 0; i < 5; i++) {

                if (i < nearest5Tx.length) {

                    var distance = parseFloat(nearest5Tx[i].distanceMiles);
                    distance = distance.toFixed(1);

                    var signalStrength = nearest5Tx[i].signalStrength;

                    var iconClass = "ui-icon-good";
                    if (signalStrength < 66) {
                        iconClass = 'ui-icon-poor';
                    } else if (signalStrength < 72) {
                        iconClass = 'ui-icon-low';
                    }

                    tempfloat = parseFloat(getBearing(lastPosition, nearest5Tx[i].position)); // parse as float
                    if (tempfloat < 0)
                        tempfloat = 360 + tempfloat;

                    nearest5Tx[i].bearing = tempfloat.toFixed(2);  // Will return "10.00"

                    var displayBearing = tempfloat.toFixed(0)
                    
                    var buttonHtml = '<table width="100%"><tr>';
                    buttonHtml += '<td class="txListName" colspan="2">' + nearest5Tx[i].name + '</td>';
                    buttonHtml += '<td class="bearingCell">' + displayBearing + '&deg;</td>';
                    buttonHtml += '</tr><tr>';
                    buttonHtml += '<td class="distanceCell" width="30%">' + distance + " miles</td>";
                    buttonHtml += '<td class="distanceCell">' + signalStrength + "dBµV/m</td>";
                    buttonHtml += '<td width="60px" align="center"><div class="' + iconClass + '"></div></td>';
                    buttonHtml += '</tr></table>';

                    $('ul').append($('<li/>', {    //here appendin `<li>`
                            'data-role': "list-divider"
                        }).append($('<a/>', {    //here appending `<a>` into `<li>`
                            'href': '#compasspage',
                            'data-transition': 'none',
                            'onclick': 'selectTx(' + i + ')',
                            'html': buttonHtml
                        })));

                    $('ul').listview('refresh');
                }
            }

            $("#txoptions").show();
        }

        $(document).on("click", ".show-page-loading-msg", function () {
            var $this = $(this),
                theme = $this.jqmData("theme") || $.mobile.loadingMessageTheme;
            $.mobile.showPageLoadingMsg(theme, "recalculating", false);

            //setTimeout(function () { $.mobile.hidePageLoadingMsg(); }, 2000);

            getLocationData();
        })
		.on("click", ".hide-page-loading-msg", function () {
		    $.mobile.hidePageLoadingMsg();
		});
        
        document.addEventListener("deviceready", onDeviceReady, false);
    </script>
</head>
<body>
    <div data-role="page" id="page1">         
        <div data-role="header">
            <h1>Antenna Aligner</h1>         
            
            <a href="#infomain" data-icon="info" class="ui-btn-right" data-iconpos="notext" data-theme="a" data-shadow="false" data-icon-shadow="false">Button Right</a>             
        </div>
        <div data-role="content"> 
            <div id="locationdata"></div>           
            <div id="txoptions" data-role="fieldcontain">
                <div style="font-weight:bold;padding-bottom:6px">Select a transmitter from the list...</div>                
                <ul data-role="listview" data-divider-theme="d" data-inset="true">                
                    <li>Please wait...</li>
                </ul>             
                <a data-role="button" class="show-page-loading-msg">Recalculate</a>
            </div>
            
        </div>
    </div>
            
    <div data-role="page" id="compasspage" data-add-back-btn="true">
    <script>
       $("#compasspage").live('pagebeforeshow', function () {
            populateTxDataPanel();
        });

        $("#compasspage").live('pageshow', function () {
           
        });
        </script>

        <div data-role="header">
            <h1>Antenna Aligner</h1>
        </div>
        <div data-role="content">             
            <div class="datapanel">
                <div class="datapanel-top">
                    <div id="selectedTx">
                        <div id="txName">
                            <b>
                                ?
                            </b>
                        </div>
                        <table width="100%">
                            <tr>
                                <td width="50%"><span class="data" id="txDistance"></span></td>
                                <td style="text-align:right"><span class="data" id="txChannels"></span> </td>
                            </tr>
                        </table>
                    </div>
                </div>
            
                <div class="datapanel-bottom" id="compassdatapanel">     
                    <div id="compassdata"></div>           
                    <div id="compass" class="view">
                        <div class="container">
                            <img class="needle" id="needle" src="images/direction-needle.png">
                            <img class="compass" id="compassback" src="images/direction-indicator.png">
                        </div>
                        <div style="padding-left:5px;padding-right:5px;font-size: 13px;">
                            Keep away from any metallic objects as they may affect the compass.
                            </div>
                    </div>
                </div>     
            </div>       
        </div>
    </div>    
    

    <div data-role="page" id="infomain" data-add-back-btn="true">
        <div data-role="header">
            <h1>Antenna Aligner</h1>
        </div>
        <div data-role="content">
           
            <img src="images/logo.png" />
           
            <div class="datapanel">
                <div class="datapanel-top" style="padding-left: 10px;padding-right: 10px;padding-bottom:10px;">
                    This app will help you to align your aerial to a Freeview transmitter.<br/><br/>
                    <b>Instructions</b><br />
                    Select a transmitter from the list, then use the compass view to point your aerial in the direction indicated by the yellow arrow.<br/><br/>
                    
                    <b>Important</b><br />
                    Please note that the top rated transmitter may not necessarily be the best one for your location. Terrain and local structures are not taken into account and may severely affect which transmitter is best for you.
                </div>
                <div class="datapanel-bottom" style="padding-left: 4px;padding-right: 4px;padding-top:10px;padding-bottom:10px;"> 
                    Problems or Suggestions?<br />
                    email <a href="mailto:aligner@chrisgeorge.org.uk">aligner@chrisgeorge.org.uk</a>
                </div>
            </div>
           
            <div class="datapanel" style="margin-top:15px;">
                <div class="datapanel-top" style="text-align:right;padding-left: 8px;padding-right: 8px;">
                    <table width="100%"><tr><td align="left">1.0.2</td><td align="right">Powered by <a href="http:\\www.vsnomad.com">Nomad</a></td></tr></table>                    
                </div>
                <div class="datapanel-bottom" id="legalstuff" style="text-align:right;padding-left: 8px;padding-right: 8px;">
                    Antenna Aligner &copy; 2012 Chris George
                </div>
            </div>
        </div>
    </div>
    
    <div data-role="dialog" id="locationError" data-transition="none">
        <div data-role="header">
            <h1>GPS Error</h1>
        </div>
        <div data-role="content">
            <p>The GPS system is not enabled.</p>
            <p>To use Antenna Aligner, please enable the GPS in your device's settings.</p>        
        </div>
    </div>
</body>
</html>
