<!DOCTYPE html>
<html>
<head>
    <title>Antenna Aligner</title>
    <script type="text/javascript" charset="utf-8" src="scripts/cordova.js"></script>
    <script src="scripts/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="scripts/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
    <script src="scripts/xui.js" type="text/javascript"></script>
    <script src="scripts/positionUtils.js" type="text/javascript"></script>
    <script src="scripts/txdata.js" type="text/javascript"></script>
    <script src="scripts/signal.js" type="text/javascript"></script>
    <link rel="Stylesheet" href="style/jquery.mobile-1.1.0.min.css" />   
    <link rel="Stylesheet" href="style/master.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" charset="utf-8">

            var $j = jQuery;
        
        // This should hopefully lock the orientation...
        window.shouldRotateToOrientation = function (newOrientation) {
            return false;
        };
      
        var lastHeading = -1; 
        var lastPosition;
        var nearest5Tx;
        var m_SelectedTxIndex = -1;
        var m_SelectedTxBearing;
        var c_DistanceLimit = 100; // in km

        function onDeviceReady() {
            
            getLocationData();
        }


        // ******************************************************************************]
        // Location Methods
        function getLocationData() {
            if (navigator.geolocation) {
                var geolocationOptions = { enableHighAccuracy: true };
            
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, geolocationOptions);
            }
            else {
                onLocationError("no geolocation");
            }           
        }

        function onLocationSuccess(position) {
            $.mobile.hidePageLoadingMsg();

            lastPosition = position;

            calculateNearestTx(lastPosition);
        }

        // onError Callback receives a PositionError object
        //
        function onLocationError() {

            $.mobile.hidePageLoadingMsg();

            // Show that the GPS is disabled in the transmitter list.
            $('ul').empty();
            $('ul').append($('<li/>', {
                'data-role': "list-divider",
                'html': "GPS Disabled"
            }));

            $('ul').listview('refresh');

            $.mobile.changePage('gpserrordialog.html', {
                transition: 'none',
                reverse: false,
                changeHash: true
            });
        }

        function selectTx(index) {

            if (index >= nearest5Tx.length) // if we've clicked on a button that has no entry in the nearest array, do nothing.
                return;

            m_SelectedTxIndex = index;
        }


        function calculateNearestTx(position) {

            $('ul').empty();

            nearest5Tx = getNearestTx(position);

            $('ul').empty();

            for (var i = 0; i < 5; i++) {

                if (i < nearest5Tx.length) {

                    var distance = parseFloat(nearest5Tx[i].distanceMiles);
                    distance = distance.toFixed(1);

                    var signalStrength = nearest5Tx[i].signalStrength;
                    
                    var iconClass = "ui-icon-good";
                    if (signalStrength < 66) {
                        iconClass = 'ui-icon-poor';
                    } else if (signalStrength < 72) {
                        iconClass = 'ui-icon-low';
                    }

                    var polarisation = nearest5Tx[i].pol;

                    var polClass = "ui-pol-horiz";
                    if ( polarisation == 'V')
                        polClass = "ui-pol-vert";

                    var tempfloat = parseFloat(getBearing(lastPosition, nearest5Tx[i].position)); // parse as float
                    if (tempfloat < 0)
                        tempfloat = 360 + tempfloat;

                    nearest5Tx[i].bearing = tempfloat.toFixed(2);  // Will return "10.00"

                    var displayBearing = tempfloat.toFixed(0);

                    var buttonHtml = '<table width="100%"><tr>';
                    buttonHtml += '<td class="txListName" colspan="2">' + nearest5Tx[i].name + '</td>';
                    buttonHtml += '<td class="bearingCell">' + displayBearing + '&deg;</td>';
                    buttonHtml += '</tr><tr>';
                    buttonHtml += '<td class="distanceCell" width="30%">' + distance + ' miles</td>';
                    buttonHtml += '<td class="distanceCell"><div class="' + polClass + '"></div></td>';
                    buttonHtml += '<td width="60px" align="center"><div class="' + iconClass + '"></div></td>';
                    buttonHtml += '</tr></table>';

                    $('ul').append($('<li/>', {    //here appendin `<li>`
                        'data-role': "list-divider"
                    }).append($('<a/>', {    //here appending `<a>` into `<li>`
                        'href': 'compass.html',
                        'data-transition': 'none',
                        'onclick': 'selectTx(' + i + ')',
                        'html': buttonHtml
                    })));

                    $('ul').listview('refresh');
                }
            }

            $("#txoptions").show();
        }
        // End location methods
        // *******************************************************************************

        
        $(document).on("click", ".show-page-loading-msg", function () {
            var $this = $(this),
                theme = $this.jqmData("theme") || $.mobile.loadingMessageTheme;
            $.mobile.showPageLoadingMsg(theme, "recalculating", false);
            
            getLocationData();
        })
            .on("click", ".hide-page-loading-msg", function () {
                $.mobile.hidePageLoadingMsg();
            });
        
        document.addEventListener("deviceready", onDeviceReady, false);
    </script>
</head>
<body>
    <div data-role="page" id="page1">         
        <div data-role="header">
            <h1>Antenna Aligner</h1>         
            
            <a href="about.html" data-icon="info" class="ui-btn-right" data-iconpos="notext" data-theme="a" data-shadow="false" data-icon-shadow="false">Button Right</a>             
        </div>
        <div data-role="content"> 
            <div id="locationdata"></div>           
            <div id="txoptions" data-role="fieldcontain">
                <div style="font-weight:bold;padding-bottom:6px">Select a transmitter from the list...</div>                
                <ul data-role="listview" data-divider-theme="d" data-inset="true">                
                    <li>Please wait...</li>
                </ul>             
                <a data-role="button" class="show-page-loading-msg">Recalculate</a>
            </div>
            
        </div>
    </div>
    

    
   
</body>
</html>
