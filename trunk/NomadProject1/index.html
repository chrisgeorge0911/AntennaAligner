<!DOCTYPE html>
<html>
<head>
    <title>Page Title</title>
    <script type="text/javascript" charset="utf-8" src="scripts/phonegap-1.4.1.js"></script>
    <script src="scripts/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="scripts/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
    <script src="scripts/xui.js" type="text/javascript"></script>
    <script src="scripts/positionUtils.js" type="text/javascript"></script>
    <script src="scripts/txdata.js" type="text/javascript"></script>
    <link rel="Stylesheet" href="style/jquery.mobile-1.1.0.min.css" />   
    <link rel="Stylesheet" href="style/fonts/ariblk.css" />
    <link rel="Stylesheet" href="style/master.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" charset="utf-8">

        var lastHeading = -1;
        var lastPosition;
        var nearest5Tx;
        var m_SelectedTxIndex = -1;
        var m_SelectedTxBearing;

        /**
        * Delay for a number of milliseconds
        */
        function sleep(delay) {
            var start = new Date().getTime();
            while (new Date().getTime() < start + delay);
        }


        function getLocationData() {        
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onError);
            }
            else {
                position = {
                    coords: {
                        latitude: 50,
                        longitude: -0.4,
                        altitude: 40.5,
                        accuracy: 65,
                        altitudeAccuracy: 30,
                        heading: 0,
                        speed: 0,
                        timestamp: 0
                    }
                };
                onLocationSuccess(position);
            }
        }

        // FOR DEBUGGING ONLY
        function getLocationData2() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onError);
            }
            else {
                position = {
                    coords: {
                        latitude: 50,
                        longitude: -0.4,
                        altitude: 40.5,
                        accuracy: 65,
                        altitudeAccuracy: 30,
                        heading: 0,
                        speed: 0,
                        timestamp: 0
                    }
                };
                onLocationSuccess(position);
            }
        }


       // END DEBUGGING


        function onLocationSuccess(position)
        {
            lastPosition = position;

            calculateNearestTx();
        }

        function getCompassData() {

            if (navigator.compass) {
                var options = { filter: 1 };

                if (eval("typeof navigator.compass.watchHeadingFilter == 'function'")) {
                    watchID = navigator.compass.watchHeadingFilter(success, onFail, options);
                }
                else {
                    navigator.compass.getCurrentHeading(success, onFail);
                    navigator.compass.watchHeading(success, onFail, { frequency: 1 });
                }
            }
            else {
                success(30);
            }          
        }

        function log10(val) {
            return Math.log(val) / Math.log(10);
        }
        
        function getFieldStrength(power, distance, channel) {

            var d = distance * 1000;  // need distance in metres
            var e = (Math.sqrt(30 * power)) / d;

            //var dbuvm = 20 * log10(e / 0.000001);

            var freq = 8 * (channel - 21) + 474;
            var lambda = 300000000 / (freq * 1000000);

            var V = 0.5 * e * lambda / 3.14159;

            var signalStrength = 20 * log10(V / 0.000001);

            signalStrength = parseFloat(signalStrength);
            return signalStrength.toFixed(1);
        }


        function getNearestTx() {

            var txList = getListOfTx();
            
            for ( var i = 0; i < txList.length; i++ )
            {
                txList[i].distance = getDistanceBetween(lastPosition, txList[i].position);
                txList[i].signalStrength = getFieldStrength(txList[i].ch1pwr, txList[i].distance, txList[i].ch1);
            }

            txList.sort(signalSort);

            var txListTop5 = new Array();


            // get the top 5 transmitters that have signal strength 66db+
            for (var i = 0; i < 5; i++) {
                    txListTop5[i] = txList[i];
            }

            return txListTop5;
        }

        function distanceSort(a, b){
            if ( a.distance > b.distance )
            {
                return 1;
            }
            else if ( a.distance < b.distance )
            {
                return -1;
            }
            else
            {
                return 0;
            }
        }

        // sort the transmitters by signal strength in descending order (strongest first)
        function signalSort(a, b) {
            return b.signalStrength - a.signalStrength;               
        }


        function success(heading) {
                   
            if (lastHeading === heading.magneticHeading) return;
            lastHeading = heading.magneticHeading;
            
            var compass = x$("#compass .compass");
                       
            compass.css({
                "-webkit-transform": "rotate(-" + lastHeading + "deg)",
                "transform": "rotate(-" + lastHeading + "deg)",
                "-moz-transform": "rotate(-" + lastHeading + "deg)",
                "z-index": "0"
            });

            if (m_SelectedTxIndex > -1) {

                var relativeHeading = parseFloat(m_SelectedTxBearing) - parseFloat(lastHeading);
                var needle = x$("#compass .needle");

                needle.css({
                    "-webkit-transform": "rotate(" + relativeHeading + "deg)",
                    "transform": "rotate(" + relativeHeading + "deg)",
                    "-moz-transform": "rotate(" + relativeHeading + "deg)",
                    "position": "absolute",
                    "z-index": "1"
                });
            }
        }
        
        function onFail() {
            alert("heading fail");
        }

        // onError Callback receives a PositionError object
        //
        function onError(error) {
            alert('code: ' + error.code + '\n' +
              'message: ' + error.message + '\n');
        }

        var showLoader = function () {
             $('.ui-loader').css('display', 'block');
            //$.mobile.showPageLoadingMsg("a", "Recalculating data", false);
        }

        //hide loader
        var hideLoader = function () {
            $('.ui-loader').css('display', 'none');
            //$.mobile.hidePageLoadingMsg();
        }

        function onDeviceReady() {
            showLoader();
            
            getLocationData();
        }

        function recalculate() {
            showLoader();
            
            setTimeout(getLocationData(), 3000);                        
        }
     

        function populateTxDataPanel() {

            tempfloat = parseFloat(getBearing(lastPosition, nearest5Tx[m_SelectedTxIndex].position)); // parse as float number
            m_SelectedTxBearing = tempfloat.toFixed(2);  // Will return "10.00"

            // reset lastHeading so that the compass is redrawn.
            lastHeading = -1;
            getCompassData();

            var nameDiv = document.getElementById('txName');
            var distanceDiv = document.getElementById('txDistance');
            var channelDiv = document.getElementById('txChannels');

            nameDiv.innerHTML = nearest5Tx[m_SelectedTxIndex].name;
            distanceDiv.innerHTML = parseFloat(nearest5Tx[m_SelectedTxIndex].distance).toFixed(1) + "km";

            channelDiv.innerHTML = "Channels: " + nearest5Tx[m_SelectedTxIndex].ch1 + ", " + nearest5Tx[m_SelectedTxIndex].ch2 + ", " + nearest5Tx[m_SelectedTxIndex].ch3;
        }

        function selectTx(index) {
            showLoader();

            if (index >= nearest5Tx.length) // if we've clicked on a button that has no entry in the nearest array, do nothing.
                return;
            
            m_SelectedTxIndex = index;
        }


        function calculateNearestTx() {

            $('ul').empty();

            nearest5Tx = getNearestTx();

            var latitude = parseFloat(lastPosition.coords.latitude);
            var longitude = parseFloat(lastPosition.coords.longitude);

            $("#locationdata").html('Latitude: ' + latitude.toFixed(1) + ', Longitude: ' + longitude.toFixed(1) + '<br />');

            $('ul').empty();

            for (var i = 0; i < 5; i++) {

                if (i < nearest5Tx.length) {

                    var distance = parseFloat(nearest5Tx[i].distance);
                    distance = distance.toFixed(1);

                    var signalStrength = nearest5Tx[i].signalStrength;

                    var iconClass = "ui-icon-good";
                    if (signalStrength < 66) {
                        iconClass = 'ui-icon-poor';
                    } else if (signalStrength < 72) {
                        iconClass = 'ui-icon-low';
                    }

                    var buttonHtml = '<table width="100%"><tr>';
                    buttonHtml += '<td class="txListName" colspan="3">' + nearest5Tx[i].name + '</td>';
                    buttonHtml += '</tr><tr>';
                    buttonHtml += '<td class="distanceCell" width="30%">' + distance + "km</td>";
                    buttonHtml += '<td class="distanceCell">' + signalStrength + "dBµV/m</td>";
                    buttonHtml += '<td width="60px" align="left"><div class="' + iconClass + '"></div></td>';
                    buttonHtml += '</tr></table>';

                    $('ul').append($('<li/>', {    //here appendin `<li>`
                            'data-role': "list-divider"
                        }).append($('<a/>', {    //here appending `<a>` into `<li>`
                            'href': '#compasspage',
                            'data-transition': 'none',
                            'onclick': 'selectTx(' + i + ')',
                            'html': buttonHtml
                        })));

                    $('ul').listview('refresh');

                    hideLoader();
                }
            }

            $("#txoptions").show();
        }


        showLoader();
        document.addEventListener("deviceready", onDeviceReady, false);
    </script>
</head>
<body>
    <div data-role="page" id="page1">         
        <div data-role="header">
            <h1>Antenna Aligner</h1>         
            
            <a href="#infomain" data-icon="info" class="ui-btn-right" data-iconpos="notext" data-theme="a" data-shadow="false" data-icon-shadow="false">Button Right</a>
             
            <!-- <a href="#dialog" data-rel="dialog">Open Dialog</a>                        -->
        </div>
        <div data-role="content">
            <div id="txoptions" data-role="fieldcontain">
                <ul data-role="listview" data-divider-theme="d" data-inset="true">                
                  
                </ul>             
                <a data-role="button" onclick="recalculate();">Recalculate</a>               
            </div>
            
        </div>
    </div>
            
    <div data-role="page" id="compasspage" data-add-back-btn="true">
    <script>
       $("#compasspage").live('pagebeforeshow', function () {
            populateTxDataPanel();
        });

        $("#compasspage").live('pageshow', function () {
            hideLoader();
        });
        </script>

        <div data-role="header">
            <!-- <a data-role="button" data-transition="none" data-mini="true" data-inline="true" href="#page1">Back</a> -->
            <h1>Antenna Aligner</h1>
        </div>
        <div data-role="content">             
            <div class="datapanel">
                <div class="datapanel-top">
                    <div id="selectedTx">
                        <div id="txName">
                            <b>
                                ?
                            </b>
                        </div>
                        <table width="100%">
                            <tr>
                                <td width="50%"><span class="data" id="txDistance"></span></td>
                                <td style="text-align:right"><span class="data" id="txChannels"></span> </td>
                            </tr>
                        </table>
                        
                         
                    </div>
                </div>
            
                <div class="datapanel-bottom" id="compassdatapanel">     
                    <div id="compassdata"></div>           
                    <div id="compass" class="view">
                        <div class="container">
                            <img class="needle" id="needle" src="images/direction-needle.png">
                            <img class="compass" id="compassback" src="images/direction-indicator.png">
                        </div>
                    </div>
                </div>     
            </div>       
        </div>
    </div>    
    

   <div data-role="page" id="infomain" data-add-back-btn="true">
        <div data-role="header">
            <h1>Antenna Aligner</h1>
        </div>
       <div data-role="content">
           <div class="datapanel">
               <div class="datapanel-top">
                   <p>Use this app to align your aerial to one of the listed Freeview transmitters.</p>
                   <p>Due to terrain and other structures, the top rated transmitter may not necessarily be the best one for your location. So the top 5 are provided.</p>
               </div>
               <div class="datapanel-bottom">
                   <p>&copy; Chris George 2012</p>
               </div>
       </div>
    </div>
</body>
</html>
