<!--<div data-role="page" id="compasspage" data-add-back-btn="true"> -->
<script type="text/javascript">
    
    $("#compasspage").live('pagebeforeshow', function () {

        

        populateCompassTxDataPanel();
    });

    $("#compasspage").live('pageshow', function () {

        
        
    });

    $('#refreshbutton').hide();
    $('#backbutton').show();
    
    var m_lastBezelHeading = 0;
    var m_lastMagHeading = 0;

    // *******************************************************************************
    // COMPASS HANDLER
    function getCompassData() {

        m_lastBezelHeading = 0;

        if (navigator.compass) {

            var options = { filter: 1 };
            if (device.platform == 'Android')
                options = { frequency: 50 };

            if (eval("typeof navigator.compass.watchHeading == 'function'")) {
                watchID = navigator.compass.watchHeading(onCompassSuccess, onCompassFail, options);
            }
        }
        else {
            alert("compass not working");
            onCompassSuccess(30);
        }
    }

    function setCompassNeedle(needleHeading) {
        var needle = x$("#compass .needle");

        needle.css({
            "-webkit-transition-property":"-webkit-transform",
            "-webkit-transition-duration":"0.5s",
            "-webkit-transform": "rotate(" + needleHeading + "deg)",
            "transform": "rotate(" + needleHeading + "deg)",
            "-moz-transform": "rotate(" + needleHeading + "deg)",
            "position": "absolute",
            "z-index": "1"
        });

    }

    //TODO NEED TO DO RELATIVE COMPASS MOVEMENTS

    function onCompassSuccess(heading) {
                
        var magHeading = heading.magneticHeading;
                     
        var compass = x$("#compass .compass");
        
        m_lastBezelHeading = CalculateBezelHeading(magHeading, m_lastMagHeading, m_lastBezelHeading);

        m_lastMagHeading = magHeading;
        
        var internalBezelHeading = (m_lastBezelHeading * -1);

        //alert(magHeading + ", " + m_lastMagHeading + ", " + m_lastBezelHeading + ", " + internalBezelHeading);
        var headingDiv = document.getElementById('heading');
        headingDiv.innerText = internalBezelHeading;


        compass.css({
            "-webkit-transition-property": "-webkit-transform",
            "-webkit-transition-duration": "0.5s",
            "-webkit-transform": "rotate(" + internalBezelHeading + "deg)",
            "transform": "rotate(" + internalBezelHeading + "deg)",
            "-moz-transform": "rotate(" + internalBezelHeading + "deg)",
            "z-index": "0"
        });

        setCompassNeedle(m_SelectedTxBearing * 1 + internalBezelHeading);
    }

    

    function onCompassFail() {
        $.mobile.changePage('compasserrordialog', {
            transition: 'none',
            reverse: false,
            changeHash: true
        });
    }

    var changeClass = function (c1, c2) {
        $(this).addClass(c2);
    };  

    function populateCompassTxDataPanel() {

        m_SelectedTxBearing = nearest5Tx[m_SelectedTxIndex].bearing;
               
        getCompassData();

        var nameDiv = document.getElementById('txName');
        var distanceDiv = document.getElementById('txDistance');
        var channelDiv = document.getElementById('txChannels');
                
        var polarisation = nearest5Tx[m_SelectedTxIndex].pol;
               
        if (polarisation == 'V') {
            jQuery('#txPol').addClass('ui-pol-vert');
        } else {
            jQuery('#txPol').addClass('ui-pol-horiz');
        }
                    
        nameDiv.innerHTML = nearest5Tx[m_SelectedTxIndex].name;
        distanceDiv.innerHTML = parseFloat(nearest5Tx[m_SelectedTxIndex].distanceMiles).toFixed(1) + " miles";

        var channelArray = nearest5Tx[m_SelectedTxIndex].channel;
        var channelsString = '';

        for (var channel in channelArray) {
            if (channelsString != '')
                channelsString += ',';

            channelsString += channelArray[channel].ch;
        }

        channelDiv.innerHTML = "Channels<br /><b>" + channelsString + "</b>";
    }

// END COMPASS HANDLER
    //*********************************************************************************************

</script>

<div class="datapanel">
    <div class="datapanel-top">
        <div id="selectedTx">
            <table width="100%">
                <tr>
                          <td class="txListName" colspan="2"><span id="txName"></span></td>
                          
                </tr><tr>
                         <td class="distanceCell" width="30%"><span id="txDistance"></span></td>
                         <td class="distanceCell"><div class="data" id="txPol"></div></td>
                         <td width="60px" align="center"><span class="data" id="txChannels"></span></td>
                     </tr>
            </table>

            
        </div>
    </div>
            
    <div class="datapanel-bottom" id="compassdatapanel">     
        <div id="compassdata"></div>           
        <div id="compass" class="view" width="200px" height="200px">
            <div class="container">
                <img class="needle" id="needle" src="images/direction-needle.png">
                <img class="compass" id="compassback" src="images/direction-indicator.png">
            </div>                        
        </div>
        <div id="heading"></div>
        <div style="padding-left:5px;padding-right:5px;font-size: 13px;">
            Keep away from any metallic objects as they may affect the compass.
        </div>
    </div>     
</div>